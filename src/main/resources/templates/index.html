<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}">Game Daemon Deck</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/bootstrap-icons/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa; /* Light gray background */
        }
        .card-header-blue {
            background-color: #007bff; /* Bootstrap primary blue */
            color: white;
            font-weight: bold;
            height: 50px; /* Specific height */
            display: flex;
            align-items: center;
            padding-left: 1rem;
        }
        .card-header-green {
            background-color: #28a745; /* Bootstrap success green */
            color: white;
            font-weight: bold;
            height: 50px; /* Specific height */
            display: flex;
            align-items: center;
            padding-left: 1rem;
        }
        .card-header-grey {
            background-color: #6c757d; /* Bootstrap secondary grey */
            color: white;
            font-weight: bold;
            height: 50px; /* Specific height */
            display: flex;
            align-items: center;
            padding-left: 1rem;
        }
        .btn-teal {
            background-color: #20c997; /* Bootstrap info teal */
            color: white;
        }
        .btn-teal:hover {
            background-color: #17a2b8; /* Darker teal/blue on hover */
            color: white;
        }
        /* Custom styles for dashed border card */
        .dashed-card {
            border: 2px dashed #6c757d; /* Gray dashed border */
            text-align: center;
            padding: 2rem;
            height: 100%; /* Ensure it takes full height of parent */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .dashed-card .bi {
            font-size: 4rem; /* Large icon size */
            color: #6c757d;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .gdd-logo-circle {
            width: 30px; /* Enforce square shape */
            height: 30px; /* Enforce square shape */
            display: flex; /* Use flexbox for centering content */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }
        /* File Browser Styles */
        .file-browser-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        .file-browser-item {
            cursor: pointer;
            padding: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }
        .file-browser-item:hover {
            background-color: #e9ecef;
        }
        .file-browser-item.selected {
            background-color: #007bff;
            color: white;
        }
        .file-browser-item i {
            margin-right: 0.5rem;
        }
        /* Log Viewer Styles */
        #logViewerContent {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', Courier, monospace;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom border-light"> <!-- Changed to light background, removed navbar-dark, added light gray bottom border -->
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="/"> <!-- Added d-flex align-items-center for vertical alignment -->
                    <span class="p-1 me-2 gdd-logo-circle" style="background-color: #007bff; border-radius: 50%;"> <!-- Blue circle background -->
                        <img src="/static/bootstrap-icons/controller.svg" alt="GDD Logo" width="20" height="20" class="d-inline-block" style="filter: invert(100%);"> <!-- White icon -->
                    </span>
                    <strong class="text-black">Game Daemon Deck</strong> <!-- Bold and black text -->
                </a>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active text-dark" aria-current="page" href="/">Dashboard</a> <!-- Changed text color to dark -->
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" href="#">Logs</a> <!-- Changed text color to dark -->
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="btn btn-outline-secondary d-flex align-items-center text-dark" href="/settings"> <!-- Changed text color to dark -->
                                <i class="bi bi-gear me-1"></i> Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Header -->
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-lg-12 text-center">
                    <h1 class="display-4">Welcome to Game Daemon Deck!</h1>
                    <p class="lead">Your game server manager is up and running.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="container mt-4">
            <div class="row">
                <!-- Left Column (col-lg-8) -->
                <div class="col-lg-8">
                    <div class="row">
                        <!-- Server Cards -->
                        <div th:each="server : ${servers}" class="col-md-6 mb-4" th:id="'server-card-' + ${server.name}">
                            <div class="card shadow-sm h-100">
                                <div class="card-header d-flex justify-content-between" th:style="'background-color:' + ${server.headerColor} + '; color:' + ${server.fontColor}">
                                    <span th:text="${server.name}">Server Name</span>
                                    <div class="d-flex align-items-center">
                                        <a href="#" class="btn btn-sm me-2 log-btn" th:style="'color:' + ${server.fontColor} + '; display: none;'" data-bs-toggle="modal" data-bs-target="#logViewerModal" th:attr="data-bs-server-name=${server.name}"><i class="bi bi-file-text"></i></a>
                                        <a href="#" class="btn btn-sm me-2 schedule-btn" th:style="'color:' + ${server.fontColor}" data-bs-toggle="modal" data-bs-target="#scheduleModal" th:attr="data-bs-server-name=${server.name}"><i class="bi bi-clock"></i></a>
                                        <a href="#" class="btn btn-sm" th:style="'color:' + ${server.fontColor}" data-bs-toggle="modal" data-bs-target="#serverConfigModal" th:attr="data-bs-server-name=${server.name}"><i class="bi bi-gear"></i></a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text" th:text="'AppID: ' + ${server.appId}">AppID: N/A</p>
                                    <p class="card-text" th:text="'Game: ' + ${server.pluginName}">Game: N/A</p>
                                    <p class="card-text status-text">Status:
                                        <span th:if="${server.running}" class="text-success"><i class="bi bi-circle-fill"></i> Running</span>
                                        <span th:unless="${server.running}" class="text-danger"><i class="bi bi-circle-fill"></i> Stopped</span>
                                    </p>
                                    <p class="card-text pid-text" th:text="${server.pid != null} ? 'PID: ' + ${server.pid} : ''"></p>
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-sm btn-primary start-btn" 
                                                th:attr="onclick='startServer(\'' + ${server.name} + '\')'"
                                                th:disabled="${server.running or server.serverPath == null or server.serverPath.isEmpty()}">Start</button>
                                        <button class="btn btn-sm btn-danger stop-btn" 
                                                th:attr="onclick='stopServer(\'' + ${server.name} + '\')'"
                                                th:disabled="${!server.running}">Stop</button>
                                        <button class="btn btn-sm btn-teal" th:disabled="${server.serverPath == null or server.serverPath.isEmpty()}">Update</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add Server Placeholder -->
                        <div class="col-md-6 mb-4">
                            <div class="card dashed-card shadow-sm h-100">
                                <i class="bi bi-plus-circle"></i>
                                <h5 class="mt-3">Add New Server</h5>
                                <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addServerModal">Add Server</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column (col-lg-4) -->
                <div class="col-lg-4">
                    <!-- Quick Actions Card -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header card-header-grey">Quick Actions</div>
                        <div class="card-body d-grid gap-2">
                            <button class="btn btn-primary">Reload All Servers</button>
                            <button class="btn btn-primary">Invalidate Caches</button>
                        </div>
                    </div>
                    <!-- System Info Card -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header card-header-grey">System Information</div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">System Health: <span class="badge bg-success">Good</span></li>
                                <li class="list-group-item">Uptime: <span>5 days</span></li>
                                <li class="list-group-item">Last Backup: <span>Yesterday</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Server Modal -->
    <div class="modal fade" id="addServerModal" tabindex="-1" aria-labelledby="addServerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addServerModalLabel">Add New Server</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/servers" method="post">
                        <div id="addServerError" class="alert alert-danger" style="display: none;"></div>
                        <div class="mb-3">
                            <label for="serverName" class="form-label">Server Name</label>
                            <input type="text" class="form-control" id="serverName" name="serverName" required>
                        </div>
                        <div class="mb-3">
                            <label for="appId" class="form-label">AppID</label>
                            <input type="text" class="form-control" id="appId" name="appId">
                        </div>
                        <div class="mb-3">
                            <label for="pluginName" class="form-label">Game</label>
                            <select class="form-select" id="pluginName" name="pluginName">
                                <option th:each="plugin : ${plugins}" th:value="${plugin.name}" th:text="${plugin.name}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="headerColor" class="form-label">Header Color</label>
                            <select class="form-select" id="headerColor" name="headerColor">
                                <option value="blue" selected>Blue</option>
                                <option value="black">Black</option>
                                <option value="white">White</option>
                                <option value="green">Green</option>
                                <option value="red">Red</option>
                                <option value="yellow">Yellow</option>
                                <option value="purple">Purple</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="fontColor" class="form-label">Font Color</label>
                            <select class="form-select" id="fontColor" name="fontColor">
                                <option value="white" selected>White</option>
                                <option value="black">Black</option>
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                                <option value="red">Red</option>
                                <option value="yellow">Yellow</option>
                                <option value="purple">Purple</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Server</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Configuration Modal -->
    <div class="modal fade" id="serverConfigModal" tabindex="-1" aria-labelledby="serverConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serverConfigModalLabel">Server Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/servers/config" method="post">
                        <input type="hidden" id="configServerName" name="serverName" value="">
                        <div id="serverConfigFields"></div>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Config Modal -->
    <div class="modal fade" id="createConfigModal" tabindex="-1" aria-labelledby="createConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createConfigModalLabel">Create Configuration File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createConfigForm">
                        <div class="mb-3">
                            <label for="configFileName" class="form-label">Filename (without extension)</label>
                            <input type="text" class="form-control" id="configFileName" name="fileName" value="serverconfig" required>
                        </div>
                        <hr>
                        <div id="createConfigFields"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createConfigSaveBtn">Save File</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">Restart Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="scheduleList" class="mb-3">
                        <!-- Time inputs will be added here -->
                    </div>
                    <button type="button" class="btn btn-outline-success btn-sm" id="addScheduleBtn"><i class="bi bi-plus-lg"></i> Add Time</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveScheduleBtn">Save Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal fade" id="fileBrowserModal" tabindex="-1" aria-labelledby="fileBrowserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileBrowserModalLabel">Select File or Directory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" id="fileBrowserUpBtn"><i class="bi bi-arrow-up"></i></button>
                            <input type="text" class="form-control" id="fileBrowserCurrentPath" readonly>
                        </div>
                    </div>
                    <div class="file-browser-list" id="fileBrowserList">
                        <!-- File items will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="fileBrowserSelectBtn">Select</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div class="modal fade" id="logViewerModal" tabindex="-1" aria-labelledby="logViewerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logViewerModalLabel">Server Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="logViewerContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="container mt-4">
        <hr class="my-4">
        <p class="text-center text-muted">Â© Charles L. Eakins, 2026</p>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        function startServer(serverName) {
            fetch('/servers/' + serverName + '/start', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        // window.location.reload(); // Removed reload, polling handles it
                    } else {
                        response.text().then(text => alert('Failed to start server: ' + text));
                    }
                })
                .catch(err => alert('Error starting server: ' + err));
        }

        function stopServer(serverName) {
            if (!confirm('Are you sure you want to stop ' + serverName + '?')) return;
            fetch('/servers/' + serverName + '/stop', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        // window.location.reload(); // Removed reload, polling handles it
                    } else {
                        response.text().then(text => alert('Failed to stop server: ' + text));
                    }
                })
                .catch(err => alert('Error stopping server: ' + err));
        }

        document.addEventListener('DOMContentLoaded', function () {
            // --- Polling Logic ---
            let serverStatuses = {}; // Cache statuses to access restartTimes

            function updateServerStatus() {
                fetch('/api/servers/status')
                    .then(response => response.json())
                    .then(statuses => {
                        statuses.forEach(status => {
                            serverStatuses[status.name] = status; // Cache for schedule modal
                            const card = document.getElementById('server-card-' + status.name);
                            if (card) {
                                const statusText = card.querySelector('.status-text');
                                const pidText = card.querySelector('.pid-text');
                                const startBtn = card.querySelector('.start-btn');
                                const stopBtn = card.querySelector('.stop-btn');
                                const logBtn = card.querySelector('.log-btn');

                                if (status.running) {
                                    statusText.innerHTML = 'Status: <span class="text-success"><i class="bi bi-circle-fill"></i> Running</span>';
                                    pidText.textContent = 'PID: ' + status.pid;
                                    startBtn.disabled = true;
                                    stopBtn.disabled = false;
                                    if (logBtn) logBtn.style.display = 'inline-block';
                                } else if (!status.configured) {
                                    statusText.innerHTML = 'Status: <span class="text-warning"><i class="bi bi-circle-fill"></i> Not Configured</span>';
                                    pidText.textContent = '';
                                    startBtn.disabled = true;
                                    stopBtn.disabled = true;
                                    if (logBtn) logBtn.style.display = 'none';
                                } else {
                                    statusText.innerHTML = 'Status: <span class="text-danger"><i class="bi bi-circle-fill"></i> Stopped</span>';
                                    pidText.textContent = '';
                                    startBtn.disabled = false; 
                                    stopBtn.disabled = true;
                                    if (logBtn) logBtn.style.display = 'none';
                                }
                            }
                        });
                    })
                    .catch(err => console.error('Error polling status:', err));
            }

            // Poll every 3 seconds
            setInterval(updateServerStatus, 3000);
            // Initial call
            updateServerStatus();

            // --- Schedule Modal Logic ---
            const scheduleModal = document.getElementById('scheduleModal');
            const scheduleList = document.getElementById('scheduleList');
            let currentScheduleServerName = null;

            scheduleModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const serverName = button.getAttribute('data-bs-server-name');
                currentScheduleServerName = serverName;
                
                scheduleList.innerHTML = ''; // Clear previous
                
                // Get existing times from cached status
                const status = serverStatuses[serverName];
                const times = (status && status.restartTimes) ? status.restartTimes : [];
                
                times.forEach(time => addTimeInput(time));
                
                // If empty, add one empty input
                if (times.length === 0) {
                    addTimeInput('');
                }
            });

            function addTimeInput(value) {
                const div = document.createElement('div');
                div.classList.add('input-group', 'mb-2');
                
                const input = document.createElement('input');
                input.type = 'time';
                input.classList.add('form-control');
                input.value = value;
                
                const removeBtn = document.createElement('button');
                removeBtn.classList.add('btn', 'btn-outline-danger');
                removeBtn.type = 'button';
                removeBtn.innerHTML = '<i class="bi bi-dash-lg"></i>';
                removeBtn.addEventListener('click', () => div.remove());
                
                div.appendChild(input);
                div.appendChild(removeBtn);
                scheduleList.appendChild(div);
            }

            document.getElementById('addScheduleBtn').addEventListener('click', () => {
                addTimeInput('');
            });

            document.getElementById('saveScheduleBtn').addEventListener('click', () => {
                const inputs = scheduleList.querySelectorAll('input[type="time"]');
                const times = Array.from(inputs)
                    .map(input => input.value)
                    .filter(val => val !== ''); // Filter out empty

                fetch('/api/servers/' + currentScheduleServerName + '/restart-times', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(times)
                })
                .then(response => {
                    if (response.ok) {
                        const modal = bootstrap.Modal.getInstance(scheduleModal);
                        modal.hide();
                        // Force update status to refresh cache
                        updateServerStatus();
                    } else {
                        alert('Failed to save schedule');
                    }
                })
                .catch(err => alert('Error saving schedule: ' + err));
            });

            // --- Log Viewer Logic ---
            const logViewerModal = document.getElementById('logViewerModal');
            let logPollInterval = null;
            let logHighlighters = [];

            logViewerModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const serverName = button.getAttribute('data-bs-server-name');
                const modalTitle = logViewerModal.querySelector('.modal-title');
                const logContent = logViewerModal.querySelector('#logViewerContent');
                
                modalTitle.textContent = 'Logs: ' + serverName;
                logContent.textContent = 'Loading logs...';

                // Fetch highlighters first
                fetch('/api/servers/' + serverName + '/log-highlighters')
                    .then(response => response.json())
                    .then(highlighters => {
                        logHighlighters = highlighters;
                        fetchLogs(); // Then fetch logs
                        logPollInterval = setInterval(fetchLogs, 2000); // Poll every 2s
                    })
                    .catch(err => console.error('Error fetching highlighters:', err));

                function fetchLogs() {
                    fetch('/api/servers/' + serverName + '/logs')
                        .then(response => response.json())
                        .then(logs => {
                            // Apply highlighting
                            const formattedLogs = logs.map(line => {
                                let formattedLine = line;
                                // Escape HTML to prevent XSS
                                formattedLine = formattedLine.replace(/&/g, "&amp;")
                                                             .replace(/</g, "&lt;")
                                                             .replace(/>/g, "&gt;")
                                                             .replace(/"/g, "&quot;")
                                                             .replace(/'/g, "&#039;");

                                for (const highlighter of logHighlighters) {
                                    try {
                                        // Use 'i' flag for case-insensitive matching
                                        const regex = new RegExp(highlighter.regex, 'i');
                                        if (regex.test(line)) { // Test original line
                                            // Wrap the whole line in a span with style
                                            // Check if color is a hex code or a class
                                            if (highlighter.color.startsWith('#')) {
                                                formattedLine = `<span style="color: ${highlighter.color}">${formattedLine}</span>`;
                                            } else {
                                                formattedLine = `<span class="${highlighter.color}">${formattedLine}</span>`;
                                            }
                                            break; // Apply first matching highlighter only (priority)
                                        }
                                    } catch (e) {
                                        console.error("Invalid regex in highlighter:", highlighter.regex);
                                    }
                                }
                                return formattedLine;
                            });

                            logContent.innerHTML = formattedLogs.join('<br>');
                            // Auto-scroll to bottom
                            logContent.scrollTop = logContent.scrollHeight;
                        })
                        .catch(err => console.error('Error fetching logs:', err));
                }
            });

            logViewerModal.addEventListener('hidden.bs.modal', function () {
                if (logPollInterval) {
                    clearInterval(logPollInterval);
                    logPollInterval = null;
                }
            });

            // --- File Browser Logic ---
            let currentBrowserPath = '';
            let targetInput = null;
            const fileBrowserModal = new bootstrap.Modal(document.getElementById('fileBrowserModal'));
            const fileBrowserList = document.getElementById('fileBrowserList');
            const currentPathInput = document.getElementById('fileBrowserCurrentPath');
            const upBtn = document.getElementById('fileBrowserUpBtn');
            const selectBtn = document.getElementById('fileBrowserSelectBtn');
            let selectedItemPath = null;

            function loadDirectory(path) {
                fetch('/api/files?path=' + encodeURIComponent(path))
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load directory');
                        return response.json();
                    })
                    .then(data => {
                        currentBrowserPath = data.currentPath;
                        currentPathInput.value = currentBrowserPath;
                        fileBrowserList.innerHTML = '';
                        selectedItemPath = null; // Reset selection on dir change

                        // Sort: Directories first, then files
                        data.files.sort((a, b) => {
                            if (a.isDirectory === b.isDirectory) {
                                return a.name.localeCompare(b.name);
                            }
                            return a.isDirectory ? -1 : 1;
                        });

                        data.files.forEach(file => {
                            const item = document.createElement('div');
                            item.classList.add('file-browser-item');
                            item.dataset.path = file.path;
                            item.dataset.isDirectory = file.isDirectory;

                            const icon = document.createElement('i');
                            icon.classList.add('bi');
                            icon.classList.add(file.isDirectory ? 'bi-folder-fill' : 'bi-file-earmark-text');
                            if (file.isDirectory) icon.classList.add('text-warning');
                            else icon.classList.add('text-secondary');

                            const name = document.createElement('span');
                            name.textContent = file.name;

                            item.appendChild(icon);
                            item.appendChild(name);

                            item.addEventListener('click', () => {
                                // Handle selection highlighting
                                document.querySelectorAll('.file-browser-item').forEach(el => el.classList.remove('selected'));
                                item.classList.add('selected');
                                selectedItemPath = file.path;
                            });

                            item.addEventListener('dblclick', () => {
                                if (file.isDirectory) {
                                    loadDirectory(file.path);
                                } else {
                                    // Select file and close
                                    selectedItemPath = file.path;
                                    selectBtn.click();
                                }
                            });

                            fileBrowserList.appendChild(item);
                        });
                    })
                    .catch(err => console.error(err));
            }

            upBtn.addEventListener('click', () => {
                // Simple parent directory logic (backend handles '..' resolution usually, or we strip last segment)
                // Here we rely on backend to handle ".." or parent path logic if we pass it, 
                // OR we can just pass the parent path if we knew it. 
                // A simple way is to ask backend for parent of current path.
                // For now, let's try passing '..' relative to current path or let backend handle it.
                // Actually, let's just strip the last segment client-side for simplicity if path separators are standard.
                // Better: Add a "parent" field to the API response. 
                // For now, let's assume the backend handles ".." appended to path? No, standard file systems do.
                // Let's try to find the parent directory string.
                // Windows/Linux separator difference might be tricky in JS without knowing OS.
                // Safest is to ask backend for parent, but we don't have that endpoint yet.
                // Let's try sending the current path + "/.." to the backend?
                // Or better, let's implement a "parent" logic in the backend API response later.
                // For this iteration, let's try to guess the parent.
                
                // Hacky client-side parent resolution:
                let separator = currentBrowserPath.includes('\\') ? '\\' : '/';
                let parts = currentBrowserPath.split(separator);
                if (parts.length > 1) {
                    // Remove last part (if empty due to trailing slash, remove two)
                    if (parts[parts.length - 1] === '') parts.pop();
                    parts.pop();
                    let newPath = parts.join(separator);
                    if (!newPath && separator === '/') newPath = '/'; // Root on linux
                    if (!newPath && separator === '\\') newPath = parts[0] + '\\'; // Drive root on windows?
                    
                    // If we can't determine, maybe just reload root? 
                    // Let's rely on the backend API update I will make next.
                    // For now, let's just try to go up by sending '..' as path? 
                    // The backend likely takes absolute paths.
                    // Let's wait for the backend update.
                    
                    // Actually, I will update the backend to handle "parent" request or return parent path.
                    // For now, let's assume the backend will support a special "parent" query param or similar?
                    // No, let's just implement the backend change first.
                    // I'll leave this button non-functional until backend is ready or use a simple string manipulation.
                     loadDirectory(currentBrowserPath + "/..");
                }
            });

            selectBtn.addEventListener('click', () => {
                if (selectedItemPath && targetInput) {
                    let finalPath = selectedItemPath;
                    // Auto-quote if path contains spaces
                    if (finalPath.includes(' ')) {
                        finalPath = '"' + finalPath + '"';
                    }

                    if (targetInput.id === 'commandLine' && targetInput.value.includes('<locationnotset>')) {
                        targetInput.value = targetInput.value.replace('<locationnotset>', finalPath);
                    } else {
                        targetInput.value = finalPath;
                    }
                    
                    // Dispatch input event to notify listeners (like the disable/enable logic)
                    targetInput.dispatchEvent(new Event('input'));
                    
                    fileBrowserModal.hide();
                }
            });

            // --- End File Browser Logic ---

            const serverConfigModal = document.getElementById('serverConfigModal');
            const createConfigModal = new bootstrap.Modal(document.getElementById('createConfigModal'));
            let currentConfigServerName = null;
            let currentConfigPluginName = null;
            let currentConfigTargetInput = null;

            serverConfigModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const serverName = button.getAttribute('data-bs-server-name');
                const modalTitle = serverConfigModal.querySelector('.modal-title');
                const serverNameInput = serverConfigModal.querySelector('#configServerName');
                modalTitle.textContent = 'Configure ' + serverName;
                serverNameInput.value = serverName;
                currentConfigServerName = serverName;

                // Find the server object from the servers list
                const servers = /*[[${servers}]]*/ [];
                const server = servers.find(s => s.name === serverName);
                if (server) {
                    currentConfigPluginName = server.pluginName;
                    fetch('/servers/config-fields?pluginName=' + server.pluginName)
                        .then(response => response.json())
                        .then(configFields => {
                            const serverConfigFields = document.getElementById('serverConfigFields');
                            serverConfigFields.innerHTML = '';
                            
                            // First pass: Create all fields
                            const createdFields = [];
                            configFields.forEach(field => {
                                const div = document.createElement('div');
                                div.classList.add('mb-3');

                                const label = document.createElement('label');
                                label.classList.add('form-label');
                                label.textContent = field.label;
                                label.htmlFor = field.name;
                                div.appendChild(label);

                                const input = document.createElement('input');
                                input.classList.add('form-control');
                                input.type = field.type;
                                input.name = field.name;
                                input.id = field.name;
                                input.value = server[field.name] || field.defaultValue || ''; 

                                if (field.name.endsWith('Path') || (field.name === 'commandLine' && field.type === 'text')) {
                                    const inputGroup = document.createElement('div');
                                    inputGroup.classList.add('input-group');
                                    inputGroup.appendChild(input);

                                    // Create Config Button (only for commandLine or specific fields if needed, but let's add it generally for path fields)
                                    // Actually, let's add it specifically if the field name suggests a config file, or just add it to the commandLine field as requested.
                                    // The user said "before you pick a config...".
                                    // Let's add it to any field that is NOT serverPath but IS a path field.
                                    if (field.name !== 'serverPath') {
                                        const createBtn = document.createElement('button');
                                        createBtn.classList.add('btn', 'btn-outline-primary');
                                        createBtn.type = 'button';
                                        createBtn.innerHTML = '<i class="bi bi-file-earmark-plus"></i>';
                                        createBtn.title = "Create/Edit Config File";
                                        createBtn.addEventListener('click', () => {
                                            currentConfigTargetInput = input;
                                            openCreateConfigModal();
                                        });
                                        // Store reference to disable/enable
                                        field.createBtn = createBtn;
                                        inputGroup.appendChild(createBtn);
                                    }

                                    const button = document.createElement('button');
                                    button.classList.add('btn', 'btn-outline-secondary');
                                    button.type = 'button';
                                    button.innerHTML = '<i class="bi bi-folder2-open"></i>';
                                    
                                    // Store reference to button for later logic
                                    field.button = button;
                                    field.input = input;

                                    inputGroup.appendChild(button);
                                    div.appendChild(inputGroup);
                                } else {
                                    div.appendChild(input);
                                }
                                serverConfigFields.appendChild(div);
                                createdFields.push(field);
                            });

                            // Second pass: Attach event listeners and logic
                            const serverPathInput = serverConfigFields.querySelector('#serverPath');
                            
                            createdFields.forEach(field => {
                                if (field.button) { // Only for fields with file pickers
                                    const button = field.button;
                                    const input = field.input;
                                    const createBtn = field.createBtn;

                                    // Logic to disable button if serverPath is empty and this is not serverPath
                                    if (field.name !== 'serverPath') {
                                        if (serverPathInput && !serverPathInput.value) {
                                            button.disabled = true;
                                            if (createBtn) createBtn.disabled = true;
                                        }
                                        
                                        // Listen for changes on serverPath to enable/disable
                                        if (serverPathInput) {
                                            serverPathInput.addEventListener('input', () => {
                                                button.disabled = !serverPathInput.value;
                                                if (createBtn) createBtn.disabled = !serverPathInput.value;
                                            });
                                        }
                                    }

                                    // Button click handler
                                    button.addEventListener('click', () => {
                                        targetInput = input;
                                        let initialPath = input.value && !input.value.includes('<') ? input.value : '.'; 
                                        
                                        // If this is NOT serverPath, try to start from serverPath's directory
                                        if (field.name !== 'serverPath') {
                                            if (serverPathInput && serverPathInput.value) {
                                                let exePath = serverPathInput.value;
                                                // Strip quotes if present
                                                if (exePath.startsWith('"') && exePath.endsWith('"')) {
                                                    exePath = exePath.substring(1, exePath.length - 1);
                                                }
                                                // Get parent directory
                                                const separator = exePath.includes('\\') ? '\\' : '/';
                                                const lastSeparatorIndex = exePath.lastIndexOf(separator);
                                                if (lastSeparatorIndex !== -1) {
                                                    // Use parent directory as initial path if input is empty or default
                                                    if (!input.value || input.value === '.' || input.value.includes('<')) {
                                                        initialPath = exePath.substring(0, lastSeparatorIndex);
                                                    }
                                                }
                                            }
                                        }

                                        // If the current value is quoted, strip quotes for the file browser
                                        if (initialPath.startsWith('"') && initialPath.endsWith('"')) {
                                            initialPath = initialPath.substring(1, initialPath.length - 1);
                                        }
                                        loadDirectory(initialPath);
                                        fileBrowserModal.show();
                                    });
                                }
                            });
                        });
                }
            });

            // --- Create Config Modal Logic ---
            function openCreateConfigModal() {
                // Check if we are editing an existing config
                let existingValues = null;
                if (currentConfigTargetInput && currentConfigTargetInput.value && !currentConfigTargetInput.value.includes('<locationnotset>')) {
                    // Try to fetch existing values
                    // We need to wait for this fetch before rendering the form
                    fetch('/api/servers/' + currentConfigServerName + '/parse-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            commandLine: currentConfigTargetInput.value
                        })
                    })
                    .then(response => {
                        if (response.ok) return response.json();
                        return null; // Ignore errors (e.g. file not found or invalid path)
                    })
                    .then(values => {
                        existingValues = values;
                        renderConfigForm(existingValues);
                    })
                    .catch(err => {
                        console.warn('Could not parse existing config:', err);
                        renderConfigForm(null);
                    });
                } else {
                    renderConfigForm(null);
                }
            }

            function renderConfigForm(existingValues) {
                const modalTitle = document.getElementById('createConfigModalLabel');
                const saveBtn = document.getElementById('createConfigSaveBtn');
                
                if (existingValues) {
                    modalTitle.textContent = 'Edit Configuration File';
                    saveBtn.textContent = 'Save Changes';
                    document.getElementById('configFileName').value = existingValues.fileName || 'serverconfig';
                } else {
                    modalTitle.textContent = 'Create Configuration File';
                    saveBtn.textContent = 'Create File';
                    document.getElementById('configFileName').value = 'serverconfig';
                }

                fetch('/api/plugins/' + currentConfigPluginName + '/server-config-fields')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch config fields');
                        return response.json();
                    })
                    .then(fields => {
                        const container = document.getElementById('createConfigFields');
                        container.innerHTML = '';
                        
                        fields.forEach(field => {
                            const div = document.createElement('div');
                            div.classList.add('mb-3');
                            
                            const label = document.createElement('label');
                            label.classList.add('form-label');
                            label.textContent = field.label;
                            label.htmlFor = 'conf_' + field.name;
                            div.appendChild(label);
                            
                            if (field.description) {
                                const desc = document.createElement('div');
                                desc.classList.add('form-text');
                                desc.textContent = field.description;
                                div.appendChild(desc);
                            }

                            let input;
                            // Determine value: existing value > default value > empty
                            let value = field.defaultValue || '';
                            if (existingValues && existingValues[field.name] !== undefined) {
                                value = existingValues[field.name];
                            }

                            if (field.type === 'select') {
                                input = document.createElement('select');
                                input.classList.add('form-select');
                                field.options.forEach(opt => {
                                    const option = document.createElement('option');
                                    option.value = opt;
                                    option.textContent = opt;
                                    if (opt === value) option.selected = true;
                                    input.appendChild(option);
                                });
                            } else if (field.type === 'boolean') {
                                input = document.createElement('select');
                                input.classList.add('form-select');
                                const optTrue = document.createElement('option');
                                optTrue.value = 'true';
                                optTrue.textContent = 'True';
                                const optFalse = document.createElement('option');
                                optFalse.value = 'false';
                                optFalse.textContent = 'False';
                                if (String(value).toLowerCase() === 'true') optTrue.selected = true;
                                else optFalse.selected = true;
                                input.appendChild(optTrue);
                                input.appendChild(optFalse);
                            } else {
                                input = document.createElement('input');
                                input.classList.add('form-control');
                                // Handle password type
                                input.type = field.type === 'password' ? 'password' : (field.type === 'number' ? 'number' : 'text');
                                input.value = value;
                            }
                            
                            input.name = field.name;
                            input.id = 'conf_' + field.name;
                            div.appendChild(input);
                            container.appendChild(div);
                        });
                        
                        createConfigModal.show();
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Error loading config fields: ' + err.message);
                    });
            }

            document.getElementById('createConfigSaveBtn').addEventListener('click', () => {
                const form = document.getElementById('createConfigForm');
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => data[key] = value);

                // Get the current serverPath from the main form
                const serverConfigFields = document.getElementById('serverConfigFields');
                const serverPathInput = serverConfigFields.querySelector('#serverPath');
                if (serverPathInput) {
                    data['serverPath'] = serverPathInput.value;
                }

                fetch('/api/servers/' + currentConfigServerName + '/create-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) return response.text().then(text => { throw new Error(text) });
                    return response.json();
                })
                .then(result => {
                    if (currentConfigTargetInput) {
                        let finalPath = result.path;
                        if (finalPath.includes(' ')) {
                            finalPath = '"' + finalPath + '"';
                        }
                        
                        if (currentConfigTargetInput.id === 'commandLine') {
                            if (currentConfigTargetInput.value.includes('<locationnotset>')) {
                                currentConfigTargetInput.value = currentConfigTargetInput.value.replace('<locationnotset>', finalPath);
                            } else {
                                // Regex to replace existing -configfile value
                                // Matches -configfile="..." or -configfile=...
                                const regex = /-configfile=(?:"[^"]*"|[^"\s]+)/;
                                if (regex.test(currentConfigTargetInput.value)) {
                                    currentConfigTargetInput.value = currentConfigTargetInput.value.replace(regex, `-configfile=${finalPath}`);
                                } else {
                                    // If not found, append it
                                     currentConfigTargetInput.value += ` -configfile=${finalPath}`;
                                }
                            }
                        } else {
                            currentConfigTargetInput.value = finalPath;
                        }
                        // Trigger input event
                        currentConfigTargetInput.dispatchEvent(new Event('input'));
                    }
                    createConfigModal.hide();
                    alert('Configuration file created successfully!');
                })
                .catch(err => alert('Error creating config: ' + err.message));
            });

            document.getElementById('saveScheduleBtn').addEventListener('click', () => {
                const inputs = scheduleList.querySelectorAll('input[type="time"]');
                const times = Array.from(inputs)
                    .map(input => input.value)
                    .filter(val => val !== ''); // Filter out empty

                fetch('/api/servers/' + currentScheduleServerName + '/restart-times', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(times)
                })
                .then(response => {
                    if (response.ok) {
                        const modal = bootstrap.Modal.getInstance(scheduleModal);
                        modal.hide();
                        // Force update status to refresh cache
                        updateServerStatus();
                    } else {
                        alert('Failed to save schedule');
                    }
                })
                .catch(err => alert('Error saving schedule: ' + err));
            });

            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error === 'duplicate_server') {
                const serverName = urlParams.get('serverName');
                const appId = urlParams.get('appId');
                const pluginName = urlParams.get('pluginName');
                const headerColor = urlParams.get('headerColor');
                const fontColor = urlParams.get('fontColor');

                document.getElementById('serverName').value = serverName;
                document.getElementById('appId').value = appId;
                document.getElementById('pluginName').value = pluginName;
                document.getElementById('headerColor').value = headerColor;
                document.getElementById('fontColor').value = fontColor;

                const errorDiv = document.getElementById('addServerError');
                errorDiv.textContent = `A server with the name '${serverName}' already exists.`;
                errorDiv.style.display = 'block';
                const addServerModal = new bootstrap.Modal(document.getElementById('addServerModal'));
                addServerModal.show();
            }
        });
    </script>
</body>
</html>